# A2A Protocol Contract (Frozen for Plexus)

Status: Approved baseline for implementation
Owner: Platform team
Applies to: `packages/backend`, `packages/frontend`
Last updated: 2026-02-20

---

## 1) Purpose

This document freezes the A2A protocol behavior Plexus will implement so all agents build against one contract.

If implementation and this document diverge, this document is the source of truth until amended.

---

## 2) Version Baseline

- Specification baseline: A2A latest released `0.3.0` (Release Candidate v1.0 line).
- Discovery path: `/.well-known/agent-card.json`.
- Supported binding for initial compliance: HTTP+JSON/REST.
- Optional secondary binding (later sprint): JSON-RPC over HTTP.

Reference:
- https://a2a-protocol.org/latest/specification/
- https://a2a-protocol.org/v0.3.0/specification

---

## 3) Plexus Endpoint Surface

To avoid collisions with existing `/v1`, `/v0`, and `/mcp` routes, Plexus hosts A2A REST under `/a2a`.

### 3.1 Discovery

- `GET /.well-known/agent-card.json`
  - Returns public agent card.

- `GET /a2a/extendedAgentCard`
  - Returns authenticated/extended card fields when caller is authorized.

### 3.2 Message and Task Operations

- `POST /a2a/message/send`
- `POST /a2a/message/stream` (SSE response)
- `GET /a2a/tasks/{taskId}`
- `GET /a2a/tasks`
- `POST /a2a/tasks/{taskId}/cancel`
- `POST /a2a/tasks/{taskId}/subscribe` (SSE subscription)

### 3.3 Push Notification Config

- `POST /a2a/tasks/{taskId}/pushNotificationConfigs`
- `GET /a2a/tasks/{taskId}/pushNotificationConfigs/{configId}`
- `GET /a2a/tasks/{taskId}/pushNotificationConfigs`
- `DELETE /a2a/tasks/{taskId}/pushNotificationConfigs/{configId}`

---

## 4) Required Headers and Content Types

### 4.1 Request headers

- `Content-Type: application/json` (except streaming subscribe semantics where applicable).
- `A2A-Version: 0.3` required for A2A endpoints.
- `A2A-Extensions: ...` optional, comma-separated URIs.
- Existing Plexus auth headers remain required where configured (`x-admin-key` / bearer flow).

### 4.2 Response headers

- `Content-Type: application/json` for non-streaming operations.
- `Content-Type: text/event-stream` for streaming endpoints.

---

## 5) Core Data Contract

## 5.1 Task state values

Plexus task state enum (wire format):
- `submitted`
- `working`
- `input-required`
- `auth-required`
- `completed`
- `failed`
- `canceled`
- `rejected`

Terminal states:
- `completed`, `failed`, `canceled`, `rejected`

Terminal states are immutable.

## 5.2 Message roles

- `user`
- `agent`
- `system`

## 5.3 Part types

- `text` (required support)
- `file` (required support for reference metadata)
- `data` (required support for structured payload)

## 5.4 Task identity

- `taskId`: UUID string generated by server unless provided by idempotent replay.
- `contextId`: stable conversation scope id for multi-turn continuity.

---

## 6) Idempotency Contract

For `POST /a2a/message/send`:

- Client may send `idempotencyKey` in request payload metadata.
- If same key is replayed with equivalent semantic request for active retention window, server returns existing task/result.
- If same key is replayed with incompatible payload, server returns `409` with `IDEMPOTENCY_CONFLICT`.
- Retention window: 24h (configurable later).

---

## 7) Error Contract

Plexus uses HTTP status + structured JSON error object.

Error envelope:

```json
{
  "error": {
    "code": "TASK_NOT_FOUND",
    "message": "Task not found",
    "details": {}
  }
}
```

Required error codes:
- `INVALID_REQUEST`
- `UNAUTHENTICATED`
- `FORBIDDEN`
- `TASK_NOT_FOUND`
- `INVALID_TASK_STATE`
- `CAPABILITY_NOT_SUPPORTED`
- `IDEMPOTENCY_CONFLICT`
- `RATE_LIMITED`
- `INTERNAL_ERROR`

HTTP mapping:
- `400`, `401`, `403`, `404`, `409`, `422`, `429`, `500`

If JSON-RPC binding is added, equivalent JSON-RPC error codes must be mapped with parity.

---

## 8) Streaming Contract

Supported transport: SSE.

Event types:
- `task-status-update`
- `task-artifact-update`
- `task-message`
- `task-complete`
- `task-failed`

Rules:
- Events are emitted in causal order per task.
- Final event includes terminal status.
- Reconnect support uses last event id cursor when available.

---

## 9) Authentication and Authorization Contract

- Inbound A2A API uses existing Plexus auth middleware patterns.
- Extended agent card fields require authenticated caller.
- Outbound A2A agent auth config supports:
  - api key
  - bearer/http auth
  - oauth2/openid metadata for future phases

Sensitive auth values must not be written to logs.

---

## 10) Compatibility Rules

- MCP endpoints and behavior must remain backward compatible.
- Existing management APIs under `/v0/management` remain stable.
- Live Metrics route `/live-metrics` remains unchanged.
- Metrics nav slot is replaced with A2A Console UI.

---

## 11) Verification Requirements

Every implementation increment must pass:

1. Endpoint contract tests for all required operations.
2. Task lifecycle transition tests including invalid transitions.
3. Idempotency replay tests.
4. Streaming tests (order, disconnect, terminal delivery).
5. Auth tests (authorized, unauthorized, forbidden).
6. Regression tests for MCP route behavior.

---

## 12) Open Items (Deferred, Not Blocking)

- Full JSON-RPC secondary binding parity.
- Signed agent card support.
- Multi-tenant partitioning model.
- WebSocket transport alternative.

These are explicitly deferred and must not block initial REST-based compliance rollout.
